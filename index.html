<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento de Salas de Reunião</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chosen Palette: Warm Neutrals -->
    <!-- Application Structure Plan: A single-page application designed around a weekly calendar grid, mimicking modern calendar apps like Google Calendar. This structure was chosen for its high usability and intuitive visual feedback. Key interactions include: 1) Navigating between weeks with 'Previous'/'Next' buttons. 2) Clicking an empty time slot to open a modal for creating an event. 3) Clicking an existing event to open a modal for editing or deleting. This task-oriented, visual-first approach is superior to a static table because it allows users to quickly assess availability and manage appointments in context, directly on the calendar interface. Data is persisted using Google's Firebase Firestore for multi-user, real-time sync. A new daily list section has been added below the calendar to provide an at-a-glance view of today's reservations, enhancing the user's ability to quickly find and understand key information. -->
    <!-- Visualization & Content Choices: 1) Main Calendar Grid: Report Info -> Scheduling data. Goal -> Organize/Display. Viz -> HTML table styled with Tailwind. Interaction -> Click on cells to create/edit events. Justification -> Most intuitive and semantically correct way to represent a weekly calendar. 2) Event Modal: Goal -> Inform/Input Data. Viz -> HTML form in a modal overlay. Interaction -> Fill form to save/delete event. Justification -> Focuses user on a single task without losing calendar context. 3) Daily Events List: Goal -> Inform. Viz -> Styled HTML list. Interaction -> Passive consumption. Justification -> Provides a quick summary of the day's events, complementing the visual calendar. 4) Color Coding: Goal -> Compare. Viz -> Different background colors for events based on the room. Interaction -> Passive visual cue. Justification -> Allows for at-a-glance differentiation between the two meeting rooms. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-family: 'Inter', sans-serif;
        }
        .calendar-grid {
            grid-template-columns: 60px repeat(5, 1fr);
            grid-template-rows: auto repeat(12, 5rem);
        }
        .time-slot {
            grid-row-start: var(--start);
            grid-row-end: var(--end);
            grid-column-start: var(--col);
        }
        @media (max-width: 768px) {
            .calendar-grid {
                grid-template-columns: 50px repeat(5, 1fr);
            }
            .day-header {
                font-size: 0.75rem;
            }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="message-box" class="fixed top-4 right-4 z-50 p-4 rounded-md shadow-lg text-white transition-opacity duration-300 hidden"></div>

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="flex items-center justify-between mb-6 flex-wrap">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-700">Agendamento de Salas</h1>
            <div id="user-info" class="flex items-center justify-end w-full md:w-auto mt-4 md:mt-0 md:absolute md:right-8 md:top-8">
                <span id="user-id-display" class="text-sm text-gray-500 font-medium">Carregando usuário...</span>
            </div>
            <div class="flex items-center space-x-2 mt-4 md:mt-0">
                <button id="today-btn" class="px-4 py-2 text-sm font-medium bg-white border border-gray-300 rounded-lg shadow-sm hover:bg-gray-100 transition-colors">Hoje</button>
                <button id="prev-week-btn" class="p-2 bg-white border border-gray-300 rounded-lg shadow-sm hover:bg-gray-100 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <button id="next-week-btn" class="p-2 bg-white border border-gray-300 rounded-lg shadow-sm hover:bg-gray-100 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <h2 id="current-week-display" class="w-full md:w-auto text-lg font-semibold text-gray-600 text-center md:text-left mt-4 md:mt-0 md:absolute md:left-1/2 md:-translate-x-1/2"></h2>
        </header>

        <p class="mb-4 text-gray-600">
            Esta é uma agenda interativa para as Salas de Reunião 1 e 2. Clique em um horário vago para criar um novo agendamento ou em um agendamento existente para editá-lo. As cores indicam a sala: <span class="font-semibold text-blue-800">Azul para Sala 1</span> e <span class="font-semibold text-teal-800">Verde para Sala 2</span>.
        </p>

        <div id="calendar-container" class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden">
            <div id="calendar-grid" class="calendar-grid grid">
            </div>
        </div>
        
        <div class="mt-8 p-6 bg-white rounded-lg shadow-md border border-gray-200">
            <h3 id="daily-list-title" class="text-xl md:text-2xl font-bold text-gray-700 mb-4">Reservas do Dia</h3>
            <div id="daily-events-list" class="space-y-4">
                <p id="no-events-message" class="text-gray-500 italic">Nenhum agendamento para hoje.</p>
            </div>
        </div>
    </div>

    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-bold">Agendar Reunião</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="event-form">
                <input type="hidden" id="event-id">
                <div class="mb-4">
                    <label for="event-title" class="block text-sm font-medium text-gray-700">Título</label>
                    <input type="text" id="event-title" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="mb-4">
                    <label for="event-responsible-name" class="block text-sm font-medium text-gray-700">Responsável</label>
                    <input type="text" id="event-responsible-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="mb-4">
                    <label for="event-date" class="block text-sm font-medium text-gray-700">Data</label>
                    <input type="date" id="event-date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="start-time" class="block text-sm font-medium text-gray-700">Início</label>
                        <input type="time" id="start-time" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" step="1800" required>
                    </div>
                    <div>
                        <label for="end-time" class="block text-sm font-medium text-gray-700">Fim</label>
                        <input type="time" id="end-time" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" step="1800" required>
                    </div>
                </div>
                <div class="mb-6">
                    <label for="event-room" class="block text-sm font-medium text-gray-700">Sala</label>
                    <select id="event-room" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="1">Sala de Reunião 1</option>
                        <option value="2">Sala de Reunião 2</option>
                    </select>
                </div>
                <div class="flex justify-between">
                    <button type="button" id="delete-event-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 hidden">Excluir</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, deleteDoc, query, where, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const calendarGrid = document.getElementById('calendar-grid');
        const currentWeekDisplay = document.getElementById('current-week-display');
        const prevWeekBtn = document.getElementById('prev-week-btn');
        const nextWeekBtn = document.getElementById('next-week-btn');
        const todayBtn = document.getElementById('today-btn');
        const messageBox = document.getElementById('message-box');
        const dailyListTitle = document.getElementById('daily-list-title');
        const dailyEventsList = document.getElementById('daily-events-list');
        const noEventsMessage = document.getElementById('no-events-message');
        const userIdDisplay = document.getElementById('user-id-display');
        
        const modal = document.getElementById('event-modal');
        const modalTitle = document.getElementById('modal-title');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const eventForm = document.getElementById('event-form');
        const eventIdInput = document.getElementById('event-id');
        const eventTitleInput = document.getElementById('event-title');
        const eventResponsibleNameInput = document.getElementById('event-responsible-name');
        const eventDateInput = document.getElementById('event-date');
        const startTimeInput = document.getElementById('start-time');
        const endTimeInput = document.getElementById('end-time');
        const eventRoomInput = document.getElementById('event-room');
        const deleteEventBtn = document.getElementById('delete-event-btn');

        let currentDate = new Date();
        let events = [];
        let db, auth, appId, userId;

        const timeSlots = Array.from({ length: 11 }, (_, i) => `${i + 8}:00`);

        const showMessage = (message, type) => {
            messageBox.textContent = message;
            messageBox.className = `fixed top-4 right-4 z-50 p-4 rounded-md shadow-lg text-white transition-opacity duration-300`;
            if (type === 'error') {
                messageBox.classList.add('bg-red-500');
            } else {
                messageBox.classList.add('bg-green-500');
            }
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        };
        
        const initializeFirebase = async () => {
            try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `Seu ID: ${userId}`;
                        setupFirestoreListener();
                    } else {
                        showMessage('Falha na autenticação do usuário.', 'error');
                    }
                });
            } catch (e) {
                console.error("Erro ao inicializar Firebase ou autenticar:", e);
                showMessage('Erro ao carregar o aplicativo.', 'error');
            }
        };

        const setupFirestoreListener = () => {
            const eventsCollectionRef = collection(db, `artifacts/${appId}/public/data/agendamentos_salas`);
            onSnapshot(eventsCollectionRef, (snapshot) => {
                events = [];
                snapshot.forEach(doc => {
                    events.push({ id: doc.id, ...doc.data() });
                });
                renderCalendar();
                renderDailyList();
            });
        };

        const renderCalendar = () => {
            calendarGrid.innerHTML = '';
            const startOfWeek = getStartOfWeek(currentDate);

            currentWeekDisplay.textContent = `${formatDate(startOfWeek)} - ${formatDate(new Date(startOfWeek.getTime() + 4 * 24 * 60 * 60 * 1000))}`;
            
            calendarGrid.appendChild(document.createElement('div'));

            for (let i = 0; i < 5; i++) {
                const day = new Date(startOfWeek.getTime() + i * 24 * 60 * 60 * 1000);
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header text-center font-semibold text-sm md:text-base p-2 border-b border-gray-200';
                dayHeader.innerHTML = `${day.toLocaleDateString('pt-BR', { weekday: 'long' })} <br> <span class="font-normal">${day.getDate()}</span>`;
                calendarGrid.appendChild(dayHeader);
            }

            timeSlots.forEach((time, index) => {
                const timeLabel = document.createElement('div');
                timeLabel.className = 'text-right text-xs pr-2 border-r border-gray-200';
                timeLabel.style.gridRow = `${index + 2}`;
                timeLabel.textContent = time;
                calendarGrid.appendChild(timeLabel);

                for (let i = 0; i < 5; i++) {
                    const cell = document.createElement('div');
                    const cellDate = new Date(startOfWeek.getTime() + i * 24 * 60 * 60 * 1000);
                    cell.className = 'border-r border-b border-gray-200 relative';
                    cell.dataset.date = cellDate.toISOString().split('T')[0];
                    cell.dataset.time = time;
                    cell.style.gridRow = `${index + 2}`;
                    cell.style.gridColumn = `${i + 2}`;
                    calendarGrid.appendChild(cell);
                }
            });
            
            renderEvents();
        };

        const renderDailyList = () => {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const dailyEvents = events.filter(event => new Date(event.start).toISOString().split('T')[0] === todayStr);

            dailyListTitle.textContent = `Reservas para ${today.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long' })}`;
            dailyEventsList.innerHTML = '';
            
            if (dailyEvents.length === 0) {
                noEventsMessage.classList.remove('hidden');
                dailyEventsList.appendChild(noEventsMessage);
            } else {
                noEventsMessage.classList.add('hidden');
                dailyEvents.sort((a, b) => new Date(a.start) - new Date(b.start));
                dailyEvents.forEach(event => {
                    const listItem = document.createElement('div');
                    listItem.className = `p-4 rounded-lg border-l-4 ${event.room === '1' ? 'bg-blue-50 border-blue-600' : 'bg-teal-50 border-teal-600'}`;
                    const responsibleName = event.reservedBy && event.reservedBy.name ? event.reservedBy.name : 'Desconhecido';
                    const isCurrentUser = event.reservedBy && event.reservedBy.id === userId;
                    listItem.innerHTML = `
                        <p class="text-base font-semibold text-gray-800">${event.title}</p>
                        <p class="text-sm text-gray-500">Reservado por: ${responsibleName} ${isCurrentUser ? '(Você)' : ''}</p>
                        <p class="text-sm text-gray-500">${formatTime(new Date(event.start))} - ${formatTime(new Date(event.end))} | Sala ${event.room}</p>
                    `;
                    dailyEventsList.appendChild(listItem);
                });
            }
        };
        
        const renderEvents = () => {
            const startOfWeek = getStartOfWeek(currentDate);
            const endOfWeek = new Date(startOfWeek.getTime() + 5 * 24 * 60 * 60 * 1000);

            const weekEvents = events.filter(event => {
                const eventStart = new Date(event.start);
                return eventStart >= startOfWeek && eventStart < endOfWeek;
            });
            
            weekEvents.forEach(event => {
                const eventStart = new Date(event.start);
                const eventEnd = new Date(event.end);
                
                const dayIndex = eventStart.getDay() === 0 ? 6 : eventStart.getDay() - 1;

                if (dayIndex >= 0 && dayIndex < 5) {
                    const durationInMinutes = (eventEnd.getTime() - eventStart.getTime()) / (1000 * 60);
                    let currentEventTime = new Date(eventStart);

                    for (let i = 0; i < durationInMinutes / 30; i++) {
                        const blockHour = currentEventTime.getHours();
                        const blockMinutes = currentEventTime.getMinutes();
                        const targetCell = document.querySelector(`[data-date='${currentEventTime.toISOString().split('T')[0]}'][data-time='${blockHour}:${blockMinutes < 10 ? '0' : ''}${blockMinutes}']`);
                        if (targetCell) {
                            targetCell.classList.add('bg-gray-200');
                        }
                        currentEventTime = new Date(currentEventTime.getTime() + 30 * 60 * 1000);
                    }
                    
                    const startHour = eventStart.getHours();
                    const startMinutes = eventStart.getMinutes();
                    const eventDiv = document.createElement('div');
                    eventDiv.dataset.eventId = event.id;
                    eventDiv.className = `absolute w-full p-2 rounded-lg text-xs cursor-pointer overflow-hidden ${event.room === '1' ? 'bg-blue-100 border border-blue-300 text-blue-800' : 'bg-teal-100 border border-teal-300 text-teal-800'}`;
                    
                    const topOffset = (startMinutes / 60) * 100;
                    const height = (durationInMinutes / 60) * 100;
                    
                    eventDiv.style.top = `${topOffset}%`;
                    eventDiv.style.height = `${height}%`;
                    
                    const responsibleName = event.reservedBy && event.reservedBy.name ? event.reservedBy.name : 'Desconhecido';
                    eventDiv.innerHTML = `<strong class="font-semibold">${event.title}</strong><br>por: ${responsibleName}`;

                    const targetCell = document.querySelector(`[data-date='${eventStart.toISOString().split('T')[0]}'][data-time='${startHour}:00']`);
                    if(targetCell) {
                         targetCell.appendChild(eventDiv);
                    }
                }
            });
        };

        const getStartOfWeek = (date) => {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        };

        const formatDate = (date) => date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
        const formatTime = (date) => date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

        const openModal = (dateStr, timeStr, eventToEdit = null) => {
            eventForm.reset();
            if (eventToEdit) {
                modalTitle.textContent = 'Editar Reunião';
                eventIdInput.value = eventToEdit.id;
                eventTitleInput.value = eventToEdit.title;
                eventResponsibleNameInput.value = eventToEdit.reservedBy && eventToEdit.reservedBy.name ? eventToEdit.reservedBy.name : '';
                const startDate = new Date(eventToEdit.start);
                const endDate = new Date(eventToEdit.end);
                eventDateInput.value = startDate.toISOString().split('T')[0];
                startTimeInput.value = formatTime(startDate).replace(':',':');
                endTimeInput.value = formatTime(endDate).replace(':',':');
                eventRoomInput.value = eventToEdit.room;
                deleteEventBtn.classList.remove('hidden');
            } else {
                modalTitle.textContent = 'Agendar Reunião';
                eventIdInput.value = '';
                eventDateInput.value = dateStr;
                startTimeInput.value = timeStr;
                eventResponsibleNameInput.value = '';
                
                const start = new Date(`${dateStr}T${timeStr}`);
                const end = new Date(start.getTime() + 60 * 60 * 1000);
                endTimeInput.value = formatTime(end);

                deleteEventBtn.classList.add('hidden');
            }
            modal.classList.remove('hidden');
        };

        const closeModal = () => modal.classList.add('hidden');

        prevWeekBtn.addEventListener('click', () => {
            currentDate.setDate(currentDate.getDate() - 7);
            renderCalendar();
            renderDailyList();
        });

        nextWeekBtn.addEventListener('click', () => {
            currentDate.setDate(currentDate.getDate() + 7);
            renderCalendar();
            renderDailyList();
        });
        
        todayBtn.addEventListener('click', () => {
            currentDate = new Date();
            renderCalendar();
            renderDailyList();
        });

        closeModalBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        calendarGrid.addEventListener('click', (e) => {
            const targetCell = e.target.closest('[data-date]');
            if (targetCell) {
                const eventDiv = e.target.closest('[data-event-id]');
                if (eventDiv) {
                    const eventId = eventDiv.dataset.eventId;
                    const eventToEdit = events.find(ev => ev.id === eventId);
                    openModal(null, null, eventToEdit);
                } else {
                    openModal(targetCell.dataset.date, targetCell.dataset.time);
                }
            }
        });

        eventForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = eventTitleInput.value;
            const responsibleName = eventResponsibleNameInput.value;
            const date = eventDateInput.value;
            const start = `${date}T${startTimeInput.value}`;
            const end = `${date}T${endTimeInput.value}`;
            const room = eventRoomInput.value;
            const id = eventIdInput.value;

            if (new Date(end) <= new Date(start)) {
                showMessage('O horário de término deve ser posterior ao horário de início.', 'error');
                return;
            }
            
            const conflictingEvent = events.find(event => 
                event.id !== id &&
                event.room === room &&
                (
                    (new Date(start) >= new Date(event.start) && new Date(start) < new Date(event.end)) ||
                    (new Date(end) > new Date(event.start) && new Date(end) <= new Date(event.end)) ||
                    (new Date(start) <= new Date(event.start) && new Date(end) >= new Date(event.end))
                )
            );
            
            if (conflictingEvent) {
                showMessage('Conflito de agendamento! Esta sala já está reservada para este horário.', 'error');
                return;
            }
            
            const eventsCollectionRef = collection(db, `artifacts/${appId}/public/data/agendamentos_salas`);

            const eventData = { title, start, end, room, reservedBy: { id: userId, name: responsibleName } };

            if (id) {
                const eventDocRef = doc(db, `artifacts/${appId}/public/data/agendamentos_salas`, id);
                await setDoc(eventDocRef, eventData);
            } else {
                await addDoc(eventsCollectionRef, eventData);
            }
            
            closeModal();
            showMessage('Agendamento salvo com sucesso!', 'success');
        });

        deleteEventBtn.addEventListener('click', async () => {
            const id = eventIdInput.value;
            const eventDocRef = doc(db, `artifacts/${appId}/public/data/agendamentos_salas`, id);
            await deleteDoc(eventDocRef);
            closeModal();
            showMessage('Agendamento excluído com sucesso!', 'success');
        });

        initializeFirebase();
    </script>
</body>
</html>
